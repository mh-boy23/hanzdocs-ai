<!DOCTYPE html>
<html lang="pt-MZ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HanzDocs AI | Documentos Profissionais Moçambique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK (Substituindo Supabase para garantir persistência seguindo as normas do ambiente) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configurações globais injetadas
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hanzdocs-mz';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.appState = { user: null, db, auth, appId };

        // Autenticação (Regra 3)
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Erro na autenticação:", err);
            }
        };

        onAuthStateChanged(auth, (user) => {
            window.appState.user = user;
            if (user) {
                document.getElementById('user-status').innerText = `ID: ${user.uid.substring(0,8)}...`;
                document.getElementById('btn-login-nav').innerText = "Ligado";
            }
        });

        initAuth();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .a4-page {
            width: 100%;
            max-width: 800px;
            min-height: 1120px;
            background: white;
            box-shadow: 0 0 40px rgba(0,0,0,0.05);
            padding: 60px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #E2E8F0;
            border-bottom-color: #2563EB;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media print { .no-print { display: none !important; } .a4-page { box-shadow: none; margin: 0; width: 100%; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <nav class="glass-nav sticky top-0 z-50 border-b border-slate-200 px-6 py-4 flex justify-between items-center no-print">
        <div class="flex items-center gap-2 font-extrabold text-2xl text-blue-600">
            <i class="fas fa-bolt"></i>
            <span>HanzDocs <span class="text-slate-900">AI</span></span>
        </div>
        <div class="flex items-center gap-4">
            <span id="user-status" class="text-xs font-bold text-slate-400"></span>
            <button id="btn-login-nav" class="bg-slate-900 text-white px-5 py-2 rounded-full text-sm font-bold">Entrar</button>
        </div>
    </nav>

    <!-- Hero -->
    <header class="py-16 px-6 text-center no-print">
        <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight mb-4">Crie Documentos no <span class="text-blue-600">Padrão Moçambicano</span></h1>
        <p class="text-slate-500 max-w-2xl mx-auto mb-8 font-medium">IA treinada para Currículos, Cartas e Minutas de acordo com as leis e práticas de RH de Moçambique.</p>
        <div class="flex justify-center gap-4">
            <a href="#editor" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold shadow-lg shadow-blue-200">Começar Agora</a>
            <a href="#precos" class="bg-white border border-slate-200 px-8 py-4 rounded-2xl font-bold">Ver Preços</a>
        </div>
    </header>

    <!-- Editor Principal -->
    <section id="editor" class="max-w-7xl mx-auto px-6 py-12 no-print">
        <div class="grid lg:grid-cols-12 gap-8">
            <!-- Sidebar de Inputs -->
            <div class="lg:col-span-4 space-y-6 bg-white p-8 rounded-3xl border border-slate-200">
                <h2 class="font-bold text-xl flex items-center gap-2"><i class="fas fa-pen-nib text-blue-600"></i> Editor de IA</h2>
                
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">O que deseja criar?</label>
                    <select id="docType" class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Curriculum Vitae">Curriculum Vitae (CV)</option>
                        <option value="Carta de Apresentação">Carta de Apresentação</option>
                        <option value="Minuta de Contrato">Minuta de Contrato</option>
                        <option value="Requerimento">Requerimento Formal</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Seu Nome / Empresa</label>
                    <input type="text" id="userName" placeholder="Ex: João Alberto" class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl outline-none">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Detalhes e Experiência</label>
                    <textarea id="userContext" rows="5" placeholder="Descreva sua experiência ou o objetivo do documento..." class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl outline-none"></textarea>
                </div>

                <button onclick="handleGenerate()" id="genBtn" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-extrabold text-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2 shadow-xl shadow-blue-100">
                    <i class="fas fa-magic"></i> Gerar Documento
                </button>
            </div>

            <!-- Preview do Documento -->
            <div class="lg:col-span-8">
                <div id="loading" class="hidden flex flex-col items-center justify-center h-full bg-white rounded-3xl border border-dashed border-slate-300">
                    <span class="loader mb-4"></span>
                    <p class="font-bold text-slate-500">A processar os dados em Maputo...</p>
                </div>

                <div id="previewArea" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest"><i class="fas fa-file-alt mr-1"></i> Formato A4 Profissional</span>
                        <div class="flex gap-2">
                            <button onclick="window.print()" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold"><i class="fas fa-download mr-2"></i>PDF / Imprimir</button>
                        </div>
                    </div>
                    <div class="a4-page shadow-2xl" id="outputContent">
                        <!-- Conteúdo da IA entra aqui -->
                    </div>
                </div>

                <div id="emptyState" class="flex flex-col items-center justify-center h-[600px] bg-slate-100/50 rounded-3xl border-2 border-dashed border-slate-200 text-slate-400">
                    <i class="fas fa-file-invoice text-6xl mb-4 opacity-20"></i>
                    <p class="font-bold">Preencha os dados para visualizar o documento</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Planos / Vendas -->
    <section id="precos" class="py-24 bg-slate-900 text-white no-print">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <h2 class="text-4xl font-extrabold mb-12">Planos de Acesso</h2>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="bg-slate-800 p-8 rounded-3xl border border-slate-700">
                    <h3 class="font-bold text-slate-400 mb-2">Básico</h3>
                    <div class="text-3xl font-black mb-6">Grátis</div>
                    <ul class="text-left space-y-4 mb-8 text-slate-400 text-sm">
                        <li><i class="fas fa-check text-blue-500 mr-2"></i> 1 Documento/mês</li>
                        <li><i class="fas fa-check text-blue-500 mr-2"></i> Template Padrão</li>
                    </ul>
                    <button class="w-full py-3 rounded-xl border border-slate-600 font-bold hover:bg-slate-700">Usar Grátis</button>
                </div>

                <div class="bg-blue-600 p-8 rounded-3xl scale-105 shadow-2xl shadow-blue-500/20">
                    <h3 class="font-bold text-blue-200 mb-2">Profissional</h3>
                    <div class="text-3xl font-black mb-1">499 MT</div>
                    <p class="text-xs text-blue-200 mb-6">Acesso Ilimitado / 30 Dias</p>
                    <ul class="text-left space-y-4 mb-8 text-sm">
                        <li><i class="fas fa-star text-yellow-300 mr-2"></i> Documentos Ilimitados</li>
                        <li><i class="fas fa-star text-yellow-300 mr-2"></i> IA Premium (GPT-4o)</li>
                        <li><i class="fas fa-star text-yellow-300 mr-2"></i> Templates de Contrato</li>
                    </ul>
                    <button onclick="payMpesa(499)" class="w-full py-4 bg-white text-blue-600 rounded-xl font-extrabold shadow-lg">Pagar com M-Pesa</button>
                </div>

                <div class="bg-slate-800 p-8 rounded-3xl border border-slate-700">
                    <h3 class="font-bold text-slate-400 mb-2">Empresas</h3>
                    <div class="text-3xl font-black mb-6">1.500 MT</div>
                    <ul class="text-left space-y-4 mb-8 text-slate-400 text-sm">
                        <li><i class="fas fa-check text-blue-500 mr-2"></i> Multi-contas</li>
                        <li><i class="fas fa-check text-blue-500 mr-2"></i> Suporte Prioritário</li>
                    </ul>
                    <button class="w-full py-3 rounded-xl border border-slate-600 font-bold hover:bg-slate-700">Contactar</button>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Função Central de Geração (Corrigindo o Erro 403 e Chamando a API corretamente)
        async function callGeminiAI(prompt, systemInstruction) {
            const apiKey = ""; // Mantido vazio para o ambiente injetar
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            let retries = 5;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text;
                    }
                    
                    if (response.status === 403) {
                        console.warn("Aguardando permissão de API ou chave...");
                    }
                } catch (e) {
                    console.error("Tentativa falhou:", i);
                }
                await new Promise(r => setTimeout(r, delay));
                delay *= 2;
            }
            throw new Error("Não foi possível conectar à IA após várias tentativas.");
        }

        async function handleGenerate() {
            const docType = document.getElementById('docType').value;
            const name = document.getElementById('userName').value;
            const context = document.getElementById('userContext').value;

            if (!name || !context) {
                alert("Por favor, preencha o seu nome e o contexto do documento.");
                return;
            }

            // UI State
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('genBtn').disabled = true;

            const systemPrompt = `Você é um especialista em RH e Direito Moçambicano. 
            Crie um ${docType} formal. Use terminologias locais como NUIT, Bilhete de Identidade, Maputo, Províncias de Moçambique.
            O texto deve ser profissional, limpo e pronto para impressão. 
            Retorne APENAS o HTML formatado com estilos inline simples para o corpo do documento.`;

            const userPrompt = `Candidato/Autor: ${name}. Contexto: ${context}. Tipo: ${docType}.`;

            try {
                const result = await callGeminiAI(userPrompt, systemPrompt);
                
                // Limpar markdown se houver
                const cleanHTML = result.replace(/```html|```/g, '').trim();
                
                document.getElementById('outputContent').innerHTML = cleanHTML;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('previewArea').classList.remove('hidden');

                // Salvar no Banco de Dados (Regra 1 e 2)
                saveDocument(docType, cleanHTML);

            } catch (err) {
                alert("Erro ao conectar à IA. Verifique se a sua sessão está ativa.");
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            } finally {
                document.getElementById('genBtn').disabled = false;
            }
        }

        async function saveDocument(type, content) {
            const { user, db, appId } = window.appState;
            if (!user) return;

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'documents', crypto.randomUUID());
                await setDoc(docRef, {
                    type,
                    content,
                    createdAt: new Date().toISOString()
                });
            } catch (e) {
                console.error("Erro ao guardar documento:", e);
            }
        }

        function payMpesa(valor) {
            const phone = prompt("Digite seu número M-Pesa (84/85):");
            if (phone && phone.length >= 9) {
                alert(`Pedido de pagamento de ${valor} MT enviado para ${phone}. Confirme no seu telemóvel.`);
            }
        }
    </script>
</body>
</html>
